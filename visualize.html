<html>
<head>
  <meta charset="UTF-8">
  <title>PKaM</title>
  <!-- APP js -->
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <!-- add d3 from web -->
  <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
  <style>

    table{
        border-style: solid;
        border-width: 2px;
        border-collapse: collapse;
        margin-left:auto; 
        margin-right:auto;
        width:500px;
        height: 100vh;
    }

    td{
        border-style: solid;
        border-width: 2px;
        vertical-align: top;
        border-collapse: collapse;
        margin-left:auto; 
        margin-right:auto;
    }

    h1{
        color:black;
        font-size:32px;
        text-align:center;
    }
    h2{
        font-size:20px;
        text-align:center;
    }
    body {
        font-family: "Helvetica Neue", Helvetica, sans-serif;
        font-size: 12px;
    }

    #desktop circle.mainBubble {
          fill: #aaa;
          stroke: #666;
          stroke-width: 1px;
    }

    text {
        fill: black;
        text-anchor: middle;
    }
   
  </style>
  
<body>
  <table>
    <tr>
      <td style="height:40px">
        <input style="margin-top:5px" type="text" id="target">
        <button style="margin-top:5px" type="button" onClick="sendTarget()">Submit!</button>
      </td>
    </tr>
    <tr>
      <td style="height:450px">
        <div style="text-align:left">
           filter: 
           <select id="flt_ctg"></select>
        </div>
        <div>
          <svg id="panel">
          </svg>
        </div>
      </td>
    </tr>
    <tr>
      <td>
        <div align="center" id="object_detail"></div>
      </td>
    </tr>
  </table>
</body>
  <script>

  var color = d3.scaleOrdinal(d3.schemeCategory20);

  var JAN_array = []; //all the Jans
  var all_ids = []; // restore all the ids of the category
  var show_ids = [];// the ids we want to shows

  var startAngle = [];
  var endAngle = [];
  var circleAttr = []; // [[length, angle, color, visible]]

  var filter = document.getElementById("flt_ctg"); 
  var svg = d3.select("#panel")
    .attr("width", 500)
    .attr("height", 500)
    .attr("viewBox", "-250 -250 500 500")
    .append("g");

  var rings;
  var bubbles;

  function call_python(method, param) {
      $.get("python:" + method + "(" + JSON.stringify(param) + ")")
  }

  function sendTarget() {
    var keyword = document.getElementById("target").value; 
    call_python("getJansFromKeyword", keyword);
  }

  function getJansFromKeyword(jan){
    JAN_array = JSON.parse(jan);
    call_python("getCategory", "");


  }

  function getCategory(category){

    while(filter.firstChild){
      filter.removeChild(filter.firstChild);
    }
    for(var i = 0 ; i < category.length; i++){
      var opt = document.createElement("option");
      opt.setAttribute("value", category[i]);
      var opt_show = document.createTextNode(category[i]);
      opt.appendChild(opt_show);
      filter.appendChild(opt);
    }
    
    call_python("getIdsFromCategory", filter.options[0].value);

    filter.onchange = function(){
      call_python("getIdsFromCategory", filter.options[filter.selectedIndex].value);
    }

  }

  function getIdsFromCategory(ids){
    all_ids = JSON.parse(ids);
    show_ids = JSON.parse(ids);

    drawRing();
  }

  function drawRing(){
    clearView();

    console.log("draw ring");

    var arc = d3.arc()
      .outerRadius(200)
      .innerRadius(185);

    var pie = d3.pie()
      .sort(null)
      .value(function(d){return d.value;});

    var wait;

    rings = svg.selectAll(".rings")
      .data(pie(show_ids))
      .enter()
      .append("g")
      .attr("class", "rings")
      .on('click', function(d,i) {
        console.log("ring click");

        if(wait){
          console.log("click twice");
          clearTimeout(wait);
          wait = null;
          if(show_ids.length > 1){
              show_ids = show_ids.slice(i,i+1);
              console.log(show_ids);
            }else{
              console.log("not slice");
              show_ids = all_ids;
          }
          drawRing();
        }else{
          wait = setTimeout(function(){
          console.log("click once");
          if(show_ids.length > 1){
            show_ids.splice(i,1);
            console.log(show_ids);
          }else{
              show_ids = all_ids;
          }
          drawRing();
          wait = null;
          },500);
        }
        
      });

    rings.append("path")
      .attr("d", arc)
      .attr("fill", function(d,i){
        startAngle[i] = d.startAngle;
        endAngle[i] = d.endAngle;
        return color(i);
      });

    rings.append("text")
      .attr("x", function(d,i){
        return getXpoint(192.5,(startAngle[i] + endAngle[i] -Math.PI)/2 );
      })
      .attr("y", function(d,i){
        return getYpoint(192.5,(startAngle[i] + endAngle[i] -Math.PI)/2 );
      })
      .text(function(d,i){
        if(d.data.name.length > 4){
          return d.data.name.substring(0,4);
        }
        return d.data.name;
      });

      drawBubbles();
  }

  function drawBubbles(){
    console.log("draw bubble");

    bubbles = svg.selectAll(".bubbles")
      .data(JAN_array)
      .enter()
      .append("g")
      .attr("class", "bubbles");

    bubbles.append("circle")
      .attr("id", function(d,i){
        var circleId;
        switch( filter.options[filter.selectedIndex].value ){
          case "type":
            circleId = d.type;
          break;
          case "author":
            circleId = d.author;
          break;
        }

        circleAttr[i] = [0,0,"#FFF",0];

        for(var j = 0; j < show_ids.length; j++){

          if(circleId == show_ids[j].name){
            var c_angle = Math.random() * (endAngle[j] - startAngle[j]) + startAngle[j] - Math.PI/2;
            var c_length = Math.random() * 150 + 20;
            var c_color = color(j);
            circleAttr[i] = [c_length, c_angle, c_color, 1];
            break;
          }
        }

        return d.uuid;
      })
      .attr("r", 10)
      .style("opacity",0.5)
      .style("visibility", function(d,i){
        if(circleAttr[i][3] == 0){
          return "hidden";
        }else{
          return "visible";
        }
      })
      .style("fill", function(d,i){
        return circleAttr[i][2];
      })
      .attr("cx", 0)
      .attr("cy", 0)
      .transition()
      .duration(1000)
      .attr("cx", function(d,i){
        return getXpoint(circleAttr[i][0], circleAttr[i][1]);
      })
      .attr("cy", function(d,i){
        return getYpoint(circleAttr[i][0], circleAttr[i][1]);
      });

    bubbles.append("text")
      .style("visibility", function(d,i){
        if(circleAttr[i][3] == 0){
          return "hidden";
        }else{
          return "visible";
        }
      })
      .style("fill", function(d,i){
        return circleAttr[i][2];
      })
      .attr("font-size", 14)
      .attr("text-anchor", "middle")
      .attr("dominant-baseline", "middle")
      .attr("alignment-baseline", "middle")
      .text(function(d,i){
        return d.uuid;
      })
      .attr("x", 0)
      .attr("y", 0)
      .transition()
      .duration(1000)
      .attr("x", function(d,i){
        return getXpoint(circleAttr[i][0], circleAttr[i][1]);
      })
      .attr("y", function(d,i){
        return getYpoint(circleAttr[i][0], circleAttr[i][1]);
      });

  }

  function getXpoint(length, angle){
    return length * Math.cos(angle);
  }

  function getYpoint(length, angle){
    return length * Math.sin(angle);
  }

  function dist(a, b) {
    return Math.sqrt(Math.pow(a[0] - b[0], 2), Math.pow(a[1] - b[1], 2));
  }

  function clearView(){
    svg.selectAll(".rings").remove();
    svg.selectAll(".bubbles").remove();
    svg.selectAll("path").remove();
    svg.selectAll("text").remove();
    svg.selectAll("rect").remove();
    svg.selectAll("circle").remove();

  }
    
  </script>
  }
  
</head>
</html>
